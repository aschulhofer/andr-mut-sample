evaluationDependsOn(':app')

apply plugin: "pl.droidsonroids.pitest"
apply plugin: "com.android.application"

pitest {
    pitestVersion = "1.2.2"

    mainSourceSets = [project(":app").android.sourceSets.main]

    // Not supported in pit gradle plugin android fork
//    testSourceSets = [project(":app").android.sourceSets.test]

    // Not needed when project.group property is set
    targetClasses = ["at.woodstick.mysampleapplication.*"]

    targetTests = ["at.woodstick.mysampleapplication.*"]

    mutators = [
            "INCREMENTS",
            "VOID_METHOD_CALLS",
            "RETURN_VALS",
            "MATH",
            "NEGATE_CONDITIONALS",
            "INVERT_NEGS",
            "CONDITIONALS_BOUNDARY",
            "REMOVE_CONDITIONALS"
    ]

    exportLineCoverage = true

    outputFormats = ["XML", "HTML"]

    threads = 4

    verbose = true

    reportDir = "${project.reporting.baseDir.path}/pitest/custom"
}

android {
    compileSdkVersion rootProject.ext.compileSdkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion

    defaultConfig {
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
    }
    sourceSets {
        main {
            res.srcDirs("../app/src/main/res")
            java.srcDirs("../app/src/main/java")
            manifest.srcFile("../app/src/main/AndroidManifest.xml")
        }

        test {
            java.srcDirs("../app/src/test/java")
        }

        androidTest {
            setRoot("../app/src/androidTest")
        }
    }

//    buildTypes {
//        mutant {
//            applicationIdSuffix ".mutant"
//        }
//    }

//    buildTypes.create("mutant1", {
//        applicationIdSuffix ".mutant1"
//    })

    testOptions {
        reportDir  "${project.reporting.baseDir.path}/test-reports"
        resultsDir "${project.reporting.baseDir.path}/test-results"
    }

//    String packageDir  = project(":app").android.defaultConfig.applicationId.replaceAll("\\.", "/")
//
//    FileTree mutants = fileTree(
//            dir: "${pitest.reportDir}/debug/$packageDir",
//            include: "**/mutants/**/*.class"
//    )
//    int numberMutants = 0;
//
//    mutants.each { File file ->
//        numberMutants++;
//
//        println file.parentFile.parentFile.parentFile.getName()
//        println file.parentFile.getName() + "\t" +  file.getName()
//
//        buildTypes.create("mutant" + numberMutants, {
//            applicationIdSuffix ".mutant" + numberMutants
//            debuggable true
//        })
//    }
}

dependencies {
    ext {
        supportLibVersion = rootProject.ext.supportLibVersion
        espressoVersion = rootProject.ext.espressoVersion
        robolectricVersion = rootProject.ext.robolectricVersion
    }

    compile fileTree(dir: "libs", include: ["*.jar"])
    compile "com.android.support:appcompat-v7:$supportLibVersion"
    compile "com.android.support.constraint:constraint-layout:1.0.2"

    androidTestCompile "com.android.support:support-annotations:$supportLibVersion"

    androidTestCompile ("com.android.support.test:rules:0.5") {
        exclude group: "com.android.support", module: "support-annotations"
    }
    androidTestCompile ("com.android.support.test:runner:0.5") {
        exclude group: "com.android.support", module: "support-annotations"
    }
    androidTestCompile ("com.android.support.test.espresso:espresso-core:$espressoVersion") {
        exclude group: "com.android.support", module: "support-annotations"
    }
    androidTestCompile ("com.android.support.test.espresso:espresso-contrib:$espressoVersion") {
        exclude group: "com.android.support", module: "support-annotations"
        exclude module: "support-v4"
        exclude module: "support-v13"
        exclude module: "recyclerview-v7"
        exclude module: "design"

    }

    androidTestCompile ("com.android.support.test.espresso:espresso-intents:$espressoVersion") {

    }

    testCompile "junit:junit:4.12"

    // newest mockito2 is 2.7.19
    testCompile "org.mockito:mockito-core:1.10.19"

    // for robolectric and sdk version not 21 or 22
    // java.lang.NoClassDefFoundError: javax/microedition/khronos/opengles/GL
    testCompile 'org.khronos:opengl-api:gl1.1-android-2.1_r1'

    testCompile "org.robolectric:robolectric:$robolectricVersion"
}


//task pmutate(type: PitestTask) {
//    doFirst {
//        println "Report dir is ${pitest.reportDir}"
//
//        pitest.reportDir = "${project.reporting.baseDir.path}/pitest/custom"
//        println "Report dir now is ${pitest.reportDir}"
//    }
//}

task cand {
    doFirst {
        project.android.buildTypes.create("mutant", {
            applicationIdSuffix ".mutant"
        })
    }

    doLast {
//        project.android.buildTypes.create("mutant", {
//            applicationIdSuffix ".mutant"
//        })
    }

    finalizedBy "assemble"
}

task mutate {
    doFirst {
        println "mutate ${project.reporting.baseDir.path}"

//        pitest.reportDir = "${project.reporting.baseDir.path}/pitest/custom"

        println "Report dir is ${pitest.reportDir}"
    }

    finalizedBy "pitestDebug"
}

task createMutantBuildTasks {

    doFirst {

    }

    doLast {
        String packageDirTask  = project(":app").android.defaultConfig.applicationId.replaceAll("\\.", "/")
        int numberMutantsTask = 0;

        FileTree mutantsTask = fileTree(
                dir: "${pitest.reportDir}/debug/$packageDirTask",
                include: "**/mutants/**/*.class"
        )

        println "Build task apk for mutant ${pitest.reportDir}/debug/$packageDirTask"

        mutantsTask.each { File file ->
            numberMutantsTask++;

            println "Build task apk for mutant $numberMutantsTask"

            task "buildApkMutant$numberMutantsTask" {
                group "mutate"

                doLast {
                    println "Build apk for mutant $numberMutantsTask"
                }
            }
        }
    }

    dependsOn "mutate"
}

task preMutate {
    doFirst {

        // Backup compiled debug class files
        copy {
            from "${project.buildDir}/intermediates/classes/debug"
            into "${project.buildDir}/intermediates/classes/debugOrg"
        }

        // Backup original debug apk
        copy {
            from "${project.buildDir}/outputs/apk/${project.name}-debug.apk"
            into "${project.buildDir}/outputs/apk/"

            include "${project.name}-debug.apk"

            rename("${project.name}-debug.apk", "${project.name}-debug.org.apk")
//            rename { String filename ->
//                filename.replace("${project.name}-debug.apk", "${project.name}-debug.org.apk")
//            }
        }
    }
}

task mutateApk {
    doFirst {

    }

    doLast {
        String packageDir  = project(":app").android.defaultConfig.applicationId.replaceAll("\\.", "/")
        int numberMutants = 0;

        FileTree mutants = fileTree(
            dir: "${pitest.reportDir}/debug/$packageDir",
            include: "**/mutants/**/*.class"
        )

        mutants.each { File file ->
            numberMutants++;
            println "Mutant $numberMutants" + "\t" + file.parentFile.getName() + "\t" +  file.getName()

            if(numberMutants == 1) {
                println "Assemble Mutant $numberMutants" + "\t" + file.parentFile.getName() + "\t" +  file.getName()
                tasks.assembleDebug.execut()
            }
        }
    }
}

task afterCompileSources {
    group 'build'

    doFirst {
        println "compileSources done."
    }

    doLast {
        println "afterCompileSources done."
    }
}

gradle.projectsEvaluated {

    println 'Gradle projects evaluated start.'

//    afterCompileSources.dependsOn compileDebugSources
//    afterCompileSources.mustRunAfter compileDebugSources

    compileDebugSources.finalizedBy afterCompileSources

    println 'Gradle projects evaluated end.'
}

task listMutants {
    doFirst {

    }

    doLast {
        String packageDir  = project(":app").android.defaultConfig.applicationId.replaceAll("\\.", "/")
        int numberMutants = 0;

        FileTree mutants = fileTree(
            dir: "${pitest.reportDir}/debug/$packageDir",
            include: "**/mutants/**/*.class"
        )

        mutants.each { File file ->
            numberMutants++;

            println "Mutant $numberMutants" + "\t" + file.parentFile.getName() + "\t" +  file.getName()
        }
    }
}
